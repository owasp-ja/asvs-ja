# V12: ファイルとリソースの検証要件

## 管理目標

検証対象のアプリケーションが以下の上位要件を満たすことを確認します。

* 信頼できないファイルのデータがセキュアな方法で適切に処理される
* 信頼できない情報源から取得したデータは，Web ルート(webroot) の外に保存され，アクセスが制限される

## V12.1 ファイルアップロード要件

高圧縮ファイル爆弾（zip bombs）はペネトレーションテスト技法を用いて充分テスト可能ですが、慎重な手動テストによる設計と開発の配慮を奨励し、かつ自動または不十分な手動ペネトレーションテストによるサービス運用妨害状態（DoS）を回避するために、L2 以上と見なされます。

| # | 説明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **12.1.1** | ストレージを圧迫させたり、DoS 攻撃を引き起こしたりする可能性のある大きなファイルをアプリケーションが受け付けない。 | ✓ | ✓ | ✓ | 400 |
| **12.1.2** | 圧縮ファイルが「高圧縮ファイル爆弾 (zip bombs)」でないことを確認する。（高圧縮ファイル爆弾(zip bombs)：小さい入力ファイルが解凍されて巨大なファイルになり、ファイルの保存容量の限界を超えて、ストレージを使用不能にする悪意のある圧縮ファイル。） | | ✓ | ✓ | 409 |
| **12.1.3** | 1 人のユーザがあまりにも多くのファイルまたは極端に大きいファイルでストレージを圧迫させることができないように、ユーザあたりのファイルサイズクォータと最大ファイル数が適用されている。 | | ✓ | ✓ | 770 |

## V12.2 ファイルの完全性の要件

| # | 説明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **12.2.1** | 信頼できない場所から取得したファイルが、期待されるファイルであることをファイルの内容に基づいて判断する。 | | ✓ | ✓ | 434 |

## V12.3 ファイル実行の要件

| # | 説明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **12.3.1** | ユーザが送信したファイル名のメタデータがシステムまたはフレームワークにより直接使用されていない。パストラバーサルから保護するために URL API が使用されている。 | ✓ | ✓ | ✓ | 22 |
| **12.3.2** | ローカルファイル（LFI）の漏えい、作成、更新、または削除を防止するために、ユーザが送信したファイル名のメタデータをバリデートもしくは無視する。 | ✓ | ✓ | ✓ | 73 |
| **12.3.3** | リモートファイルインクルージョン (Remote File Inclusion, RFI) またはサーバサイドリクエストフォージェリ (Server-side Request Forgery, SSRF) 攻撃によるリモートファイルの漏えいまたは実行を防ぐために、ユーザが送信したファイル名のメタデータをバリデートもしくは無視する。 | ✓ | ✓ | ✓ | 98 |
| **12.3.4** | アプリケーションを反射型ファイルダウンロード（Reflective File Download, RFD）から保護するため、ユーザが送信したファイル名（JSON、JSONP または URL パラメータの中にある）をバリデートまたは無視し、レスポンスのContent-Type ヘッダは text/plain に設定、および ContentDisposition ヘッダは固定ファイル名を指定する。 | ✓ | ✓ | ✓ | 641 |
| **12.3.5** | OS コマンドインジェクションから保護するために、信頼できないファイルメタデータをシステム API またはライブラリで直接使用しない。 | ✓ | ✓ | ✓ | 78 |
| **12.3.6** | アプリケーションは、未検証のコンテンツ配信ネットワーク、JavaScript ライブラリ、ノード npm ライブラリ、サーバサイド DLL などの信頼できない場所からの機能を含まず、かつ実行されない。 |  | ✓ | ✓ | 829 |

## V12.4 ファイル保存の要件

| # | 説明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **12.4.1** | 信頼できない場所から取得したファイルは、Web ルート以外にパーミッションを制限した上で保存し、可能な限り厳密なバリデーションを行う。 | ✓ | ✓ | ✓ | 922 |
| **12.4.2** | 信頼できない場所から取得したファイルが、アプリケーションが想定する種類であることを検証し、既知の悪性コンテンツがアップロードされるのを防止するためにアンチウイルスソフトで検査する。 | ✓ | ✓ | ✓ | 509 |

## V12.5 ファイルダウンロードの要件

| # | 説明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **12.5.1** | 意図しない情報やソースコードの漏えいを防ぐために、特定のファイル拡張子を持つファイルのみを処理するように Web 層が構成されている。例えば、バックアップファイル（.bak など）、一時作業ファイル（.swp など）、圧縮ファイル（.zip、.tar.gz など）およびエディタで一般的に使用されるその他の拡張子は、必要ない限り処理しない。 | ✓ | ✓ | ✓ | 552 |
| **12.5.2** | アップロードされたファイルへの直接のリクエストが HTML/JavaScript コンテンツとして実行されない。 | ✓ | ✓ | ✓ | 434 |

## V12.6 SSRF からの保護要件

| # | 説明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---:| :---: | :---: |
| **12.6.1** | Web サーバまたはアプリケーションサーバが、リクエストを送信したりデータ/ファイルをロードしたりできるように、リソースまたはシステムに許可リストが構成されている。 | ✓ | ✓ | ✓ | 918 |

## 参考情報

詳しくは以下の情報を参照してください。

* [File Extension Handling for Sensitive Information](https://owasp.org/www-community/vulnerabilities/Unrestricted_File_Upload)
* [Reflective file download by Oren Hafif](https://www.trustwave.com/Resources/SpiderLabs-Blog/Reflected-File-Download---A-New-Web-Attack-Vector/)
* [OWASP Third Party JavaScript Management Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Third_Party_Javascript_Management_Cheat_Sheet.html)
