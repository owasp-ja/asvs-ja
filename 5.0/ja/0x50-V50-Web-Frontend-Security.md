# V50 Web フロントエンドセキュリティ

このカテゴリはアプリケーションの Web フロントエンドを介して実行される攻撃から保護する要件に焦点を当てています。これらの要件はマシン間ソリューションには関係ありません。

## V1.50 Web フロントエンドセキュリティドキュメント

アプリケーションドキュメントには、必要なブラウザのセキュリティ機能を明記しなければなりません。

| # | 説明 | レベル | CWE |
| :---: | :--- | :---: | :---: |
| **1.50.1** | [追加] アプリケーションドキュメントには、アプリケーションを使用するブラウザがサポートする必要がある想定されるセキュリティ機能 (HTTPS、HSTS、コンテンツセキュリティポリシー (CSP)、その他の関連する HTTP セキュリティメカニズムなど) を記載している。これらの機能の一部が利用できない場合にアプリケーションがどのように動作しなければならないか (ユーザへの警告やアクセスのブロックなど) も定義する必要がある。| 3 | |

## V50.1 サイト分離アーキテクチャ

同一オリジン分離の利点を活用するには、アプリケーションは個別のホスト名でホストする必要があります。

| # | 説明 | レベル | CWE |
| :---: | :--- | :---: | :---: |
| **50.1.1** | [追加, 3.4.5 を廃止] あるオリジンでロードされたドキュメントやスクリプトが別のオリジンのリソースとやり取りする方法や、Cookie のホスト名制限など、同一オリジンポリシーによって提供される制限を活用するために、別のアプリケーションは異なるホスト名でホストされている。 | 1 | 668 |

## V50.2 クッキーセットアップ

| # | 説明 | レベル | CWE |
| :---: | :--- | :---: | :---: |
| **50.2.1** | [修正, 3.4.1 から移動] クッキーには 'Secure' 属性が設定されており、クッキー名に '\__Host-' プレフィックスが使用されていない場合は、クッキー名に '__Secure-' プレフィックスを使用しなければならない。 | 1 | 614 |
| **50.2.2** | [修正, 3.4.2 から移動, レベル L1 > L2] クッキーの値がクライアントサイドスクリプトからアクセスされることを意図していない場合 (セッショントークンなど)、クッキーは 'HttpOnly' 属性が設定されていなければならず、同じ値 (セッショントークンなど) は 'Set-Cookie' ヘッダフィールドを介してのみクライアントに転送されなければならない。 | 2 | 1004 |
| **50.2.3** | [修正, 3.4.3 から移動, レベル L1 > L2] 各クッキーの 'SameSite' 属性値はクッキーの目的に応じて設定され、クロスサイトリクエストフォージェリ攻撃やユーザインタフェースレドレス攻撃への露出を制限している。 | 2 | 1275 |
| **50.2.4** | [修正, 3.4.4 から移動, レベル L1 > L2] クッキーは、明示的に他のホストと共有するように設計されていない限り、クッキー名に '__Host-' プレフィックスを付けている。 | 2 | |
| **50.2.5** | [追加] アプリケーションがクッキーを書き込む際、クッキー名と値を合わせた長さは 4096 バイトを超えない。大きすぎるクッキーはブラウザに保存されないため、リクエストとともに送信されず、ユーザはそのクッキーに依存するアプリケーション機能を使用できなくなる。 | 2 | |

## V50.3 ブラウザのセキュリティメカニズムヘッダ

HTTP レスポンスには、ブラウザがコンテンツを安全にレンダリングするためのルールを設定するセキュリティヘッダを含めなければなりません。

| # | 説明 | レベル | CWE |
| :---: | :--- | :---: | :---: |
| **50.3.1** | [修正, 14.4.3 から移動, レベル L1 > L2] すべての HTTP レスポンスには Content-Security-Policy ヘッダを含み、悪意のある JavaScript のリスクを軽減している。ディレクティブ object-src 'none' および base-uri 'none' を定義しなければならない。L3 アプリケーションでは、ナンスまたはハッシュを用いたレスポンスごとのポリシーを定義しなければならない。 | 2 | |
| **50.3.2** | [文法, 14.4.4 から移動] すべてのレスポンスに X-Content-Type-Options: nosniff ヘッダフィールドが含まれている。 | 1 | 116 |
| **50.3.3** | [修正, 14.4.5 から移動] Strict-Transport-Security ヘッダフィールドがすべてのレスポンスとすべてのサブドメインに含まれている。例えば、Strict-Transport-Security：max-age=31536000; includeSubdomains | 1 | 523 |
| **50.3.4** | [修正, 14.4.6 から移動] 適切な Referrer-Policy ヘッダが含まれており、URL 内の機密情報が Referer ヘッダを介して信頼できないパーティに公開されることを防いでいる。 | 1 | 116 |
| **50.3.5** | [修正, 14.4.7 から移動] デフォルトでは Web アプリケーションのコンテンツはサードパーティサイトに埋め込むことができず、Content-Security-Policy frame-ancestors ディレクティブを使用して、必要な場合にのみ特定のリソースの埋め込みが許可される。X-Frame-Options は現在廃止されていることに注意する。 | 1 | 1021 |
| **50.3.6** | [追加, 14.5.3 から分割] クロスオリジンリソース共有 (CORS) Access-Control-Allow-Origin ヘッダフィールドが信頼できるオリジンの厳密な許可リストに対して検証されている。 "Access-Control-Allow-Origin: *" を使用する必要がある場合、レスポンスに機密情報が含まれていない。 | 1 | 183 |
| **50.3.7** | [追加] Content-Security-Policy ヘッダフィールドが違反を報告する場所を指定している。 | 3 | |

## V50.4 ブラウザのオリジン分離

サーバサイドで機密機能へのリクエストを受け入れる場合、それがアプリケーション自体あるいは信頼できるパーティによって開始され、攻撃者によって偽造されていないことを確認する必要があります。

このコンテキストにおける機密機能には、認証されたユーザと認証されていないユーザのフォーム投稿の受け入れ (認証リクエストなど)、状態変更操作、リソース要求機能 (データエクスポートなど) があります。

ここでの重要な保護は JavaScript の Same Origin Policy やクッキーの SameSite ロジックなどのブラウザセキュリティポリシーです。もう一つの一般的な保護は CORS プリフライトメカニズムです。このメカニズムは、異なるオリジンから呼び出されるように設計されたエンドポイントにとって重要ですが、異なるオリジンから呼び出されるように設計されていないエンドポイントにとっても、リクエストフォージェリ防止メカニズムとして役立ちます。

カテゴリには以下のアイデアでの要件を含む必要があります。

* リクエストが信頼できるパーティにより開始されたこと (CSRF, CORS 構成ミス)
* レスポンスは信頼できるパーティのみに読み取れること (CORS 構成ミス)

| # | 説明 | レベル | CWE |
| :---: | :--- | :---: | :---: |
| **50.4.1** | [修正, 4.2.2 から移動, 13.2.3 をカバー] 機密機能への CORS セーフリストリクエストをチェックして、アプリケーション自体から発信したものであることを確認している。これはフォージェリ防止トークンを使用して検証するか、CORS セーフリストリクエストヘッダではない追加の HTTP ヘッダを要求することで行われる。これは、一般にクロスサイトリクエストフォージェリ (CSRF) と呼ばれる、ブラウザベースのリクエストフォージェリ攻撃を防御するためのものである。 | 1 | 352 |
| **50.4.2** | [追加] メッセージのオリジンが信頼できない場合、またはメッセージの構文が無効な場合、postMessage インタフェースによって受信したメッセージを破棄している。 | 2 | 346 |
| **50.4.3** | [修正, 13.2.5 から移動, 14.5.3 から分割, 13.2.3 をカバー] アプリケーションが CORS プリフライトメカニズムに依存して、機密機能の許可されていないクロスオリジン使用を防止している場合、CORS セーフリストリクエストで機能を呼び出すことはできない。これは 'Origin' および 'Content-Type' リクエストヘッダの値をチェックするか、CORS セーフリストではない追加のヘッダフィールドを使用する必要があるかもしれない。 | 1 | 346 |
| **50.4.4** | [修正, 13.2.1 から移動] 機密機能の呼び出しは POST, PUT, PATCH, DELETE などの適切な HTTP メソッドを使用し、HEAD, OPTIONS, GET などの HTTP 仕様で「安全」と定義されているメソッドを使用しない。あるいは、Sec-Fetch-* リクエストヘッダフィールドの厳密なバリデーションを使用して、不適切なクロスオリジンコール、ナビゲーションリクエスト、期待されていないリソースロード (画像ソースなど) からリクエストが発生していないことを確保している。これはアプリケーションが URL パラメータとメッセージボディパラメータを区別しない場合に特に重要である。 | 1 | 650 |

## V50.5 クロスサイトスクリプトインクルージョン

JSONP はデータ窃取につながる可能性のあるアンチパターンです。機密データを含むスクリプトの認可が不十分だと、クロスサイトスクリプティングインクルージョン (XSSI) 攻撃につながる可能性があります。

| # | 説明 | レベル | CWE |
| :---: | :--- | :---: | :---: |
| **50.5.1** | [追加] クロスサイトスクリプトインクルージョン (XSSI) 攻撃を避けるために、JSONP 機能はアプリケーションのどの部分でも有効になっていない。 | 1 | |
| **50.5.2** | [追加] クロスサイトスクリプトインクルージョン (XSSI) 攻撃を防ぐために、認可が必要なデータは JavaScript ファイルなどのスクリプトリソースレスポンスには含まれていない。 | 1 | |

## V50.6 意図しないコンテンツ解釈

コンテンツや機能を不適切なコンテンツでレンダリングすると、さまざまなセキュリティ問題につながる可能性があります。

| # | 説明 | レベル | CWE |
| :---: | :--- | :---: | :---: |
| **50.6.1** | [修正, 12.5.2 から移動, 1.12.2, 14.4.2 からマージ] ブラウザが不正なコンテキスト (API、ユーザがアップロードしたファイル、または他のリソースが直接リクエストされる場合など) で HTTP レスポンスのコンテンツや機能をレンダリングすることを防ぐために、セキュリティ制御が行われている。可能な制御には、HTTP リクエストヘッダフィールドが、Sec-Fetch-\* など、正しいコンテキストであることを示さない限りコンテンツを提供しないこと、"Content-Security-Policy: sandbox" ヘッダを使用するか、"Content-Disposition: attachment" ヘッダを使用することを含む。 | 1 | |
| **50.6.2** | [追加, 5.3.3 から分割] HTML としてレンダリングするのではなく、テキストとして表示することを意図したコンテンツは、HTML や JavaScript などのコンテンツの意図しない実行を防ぐために、安全なレンダリング関数 (createTextNode や textContent など) を使用して処理している。 | 1 | |

## V50.7 外部リソース完全性

サードパーティのサイトでコンテンツをホストすると、悪意のあるコンテンツ改変やサプライチェーン攻撃につながる可能性があります。

| # | 説明 | レベル | CWE |
| :---: | :--- | :---: | :---: |
| **50.7.1** | [修正, 14.2.3 から移動] JavaScript ライブラリ、CSS、Web フォントなどのクライアントサイド資産がコンテンツ配信ネットワーク（Content Delivery Network, CDN）または外部プロバイダで外部的にホストされている場合、資産の整合性を検証するためにサブリソース完全性（SRI）が使用されている。 | 1 | 829 |

## V50.8 ブラウザのセキュリティに関するその他の考慮事項

<!--
it may need other separate section for "end-user protection via UI"
-->

| # | 説明 | レベル | CWE |
| :---: | :--- | :---: | :---: |
| **50.8.1** | [追加, 5.1.5 から分割] ユーザがアプリケーションの制御外の URL にリダイレクトされる場合、アプリケーションはナビゲーションをキャンセルするオプションとともに通知を表示している。 | 3 | |
| **50.8.2** | [修正, 1.14.6 から移動] アプリケーションは依然としてサポートされており安全であると考えられているクライアント側テクノロジのみを使用している。この要件を満たさないテクノロジの例としては NSAPI プラグイン、Flash、Shockwave、ActiveX、Silverlight、NACL、またはクライアントサイドの Java アプレットなどがある。 | 2 | 477 |
| **50.8.3** | [追加] アプリケーションへのアクセスに使用されるブラウザが、想定されるセキュリティ機能をサポートしていない場合、アプリケーションはドキュメントに記載されているとおりに動作する (ユーザへの警告やアクセスのブロックなど)。 | 3 | |
| **50.8.4** | [追加] アプリケーションのトップレベルドメイン (例: site.tld) がパブリック HSTS プリロードリストに追加され、アプリケーションの TLS の使用が、関連する HTTP レスポンスヘッダフィールドのみに依存するのではなく、メインブラウザに直接組み込まれる。 | 3 | |
| **50.8.5** | [追加, 5.1.5 から分割] アプリケーションは、宛先が許可リストに記載されているもののみ、アプリケーション URL から直接別の URL にユーザーを自動的にリダイレクトしている。 | 1 | 601 |

## 参考情報

詳しくは以下の情報を参照してください。

* [Set-Cookie __Host- prefix details](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie#cookie_prefixes)
* [OWASP Content Security Policy Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Content_Security_Policy_Cheat_Sheet.html)
* [Exploiting CORS misconfiguration for BitCoins and Bounties](https://portswigger.net/blog/exploiting-cors-misconfigurations-for-bitcoins-and-bounties)
* [Sandboxing third-party components](https://cheatsheetseries.owasp.org/cheatsheets/Third_Party_Javascript_Management_Cheat_Sheet.html#sandboxing-content)
* [OWASP Secure Headers Project](https://owasp.org/www-project-secure-headers/)
* [OWASP Cross-Site Request Forgery Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html)
* [HSTS Browser Preload List submission form](https://hstspreload.org/)
