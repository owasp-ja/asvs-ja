# V10 セキュアコーディングアーキテクチャと実装

## 管理目標

多くの ASVS 要件は、認証やアクセス制御などの特定のセキュリティ領域に関連しているか、ログ記録やファイル処理などの特定のタイプのアプリケーション機能に関連しています。

しかし、この章ではアプリケーションのビルド方法と安全なコードを正しく記述する方法について、より一般的なガイダンスを提供します。クリーンなアーキテクチャとコード品質の観点からだけでなく、アプリケーションを安全にするために従う必要がある特定のアーキテクチャとコーディングプラクティスについても説明します。

この章にはアプリケーションへの悪意のあるコードの侵入を防ぐための要件も含みます。

## V10.1 コード整合性

<!--
悪性コードに対する最良の防御策は、「信頼はするが、検証もする」ことです。 不正なコードや悪性コードを取り込むことは、多くの管轄で犯罪行為となっています。そして 悪性コードを無くすためにガイドラインを設ける必要があります。

リード開発者による定期的なコードチェック（特に時間、I/O、またはネットワーク機能にアクセスする可能性があるコード）を行う必要があります。
-->

| # | 説明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **10.1.1** | [削除, スコープ外] | | | | |

## V10.2 悪意コード検索

悪性コードが作り込まれることは極めてまれです。また検出は困難です。コードを 1 行 1 行レビューするのはロジックボムを検出する助けにはなるでしょうが、最も経験を積んだコードレビュー担当者をもってしても、存在すると分かっていても悪性コードを見つけることは容易ではありません。そのため、このセクションのほとんどは L3 です。サードパーティのライブラリを含むソースコードへの完全なアクセスがなければ、このセクションに準拠することはできません。

結局のところ、悪性コードを完全に見つけることは不可能です。コードの中に悪性コードや不要な機能が含まれていないことを確認するために、最善の努力を払う必要があります。

| # | 説明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **10.2.1** | アプリケーションのソースコードおよびサードパーティライブラリに、不正な通信 (“phone home”) またはデータ収集機能が含まれていないようにする。このような機能がある場合は、データを収集する前にユーザの許可を受ける。 | | ✓ | ✓ | 359 |
| **10.2.2** | [8.3.11 へ移動] | | | | |
| **10.2.3** | アプリケーションのソースコードおよびサードパーティのライブラリにバックドアが含まれていない。（ハードコードされたアカウントや鍵、文書化されていないアカウントや鍵、コードの難読化、文書化されていないバイナリ BLOB、ルートキット、アンチデバッグ、危険なデバッグ機能、古い機能、隠された機能） | | | ✓ | 507 |
| **10.2.4** | 日付と時刻関連の機能を検索して、アプリケーションのソースコードとサードパーティのライブラリに時限爆弾(time bomb)が含まれていない。 | | | ✓ | 511 |
| **10.2.5** | アプリケーションのソースコードとサードパーティのライブラリに、サラミ攻撃、ロジックバイパス (logic bypasses)、ロジックボム (logic bombs) などの悪意のあるコードが含まれていない。 | | | ✓ | 511 |
| **10.2.6** | アプリケーションのソースコードとサードパーティのライブラリにイースターエッグやその他の望ましくない機能が含まれていない。 | | | ✓ | 507 |

## V10.3 アプリケーションの整合性

アプリケーションがデプロイされた後も、悪性コードが挿入される可能性があります。 アプリケーションは、信頼されていないソースからの未署名のコードの実行やサブドメインテイクオーバ（subdomain takeover）などの一般的な攻撃から自身を保護する必要があります。

このセクションに準拠するには運用上、持続的に進める必要があります。

| # | 説明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **10.3.1** | アプリケーションにクライアントまたはサーバの自動更新機能がある場合は、安全なチャネルを経由して、デジタル署名がされていることを確認する。インストールまたは実行する前に、アップデートするコードのデジタル署名を検証する必要がある。 | ✓ | ✓ | ✓ | 16 |
| **10.3.2** | [修正] アプリケーションがコード署名などの完全性保護を採用している場合にのみ、アプリケーションの直接の制御または保護下にないソースからのコード、モジュール、コンテンツ、プラグインをロードまたは実行している。 | ✓ | ✓ | ✓ | 829 |
| **10.3.3** | [削除, スコープ外] | | | | |

## V10.4 防御的コーディング

| # | 説明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **10.4.1** | [追加] アプリケーションは変数が正しい型であることを明示的に保証し、厳密な等価演算と比較演算を実行して、アプリケーションコードが変数の型について仮定することによって引き起こされる型ジャグリングや型コンフュージョンの脆弱性を回避している。 | ✓ | ✓ | ✓ | 843 |
| **10.4.2** | [追加] アプリケーションは、明示的な変数宣言の採用、厳密な型チェックの実行、document オブジェクトへのグローバル変数の保存の回避、名前空間分離の実装によって、クライアントサイド JavaScript を使用する際の DOM clobbering を回避している。 | | ✓ | ✓ | 79 |
| **10.4.3** | [追加] JavaScript コードはオブジェクトリテラルの代わりに Set() や Map() を使用するなど、プロトタイプ汚染を防ぐ方法で記述している。 | | ✓ | ✓ | |
| **10.4.4** | [修正, 5.1.2 から移動] アプリケーションには、コントローラやアクションごとに許可されるフィールドを制限することで、大量割り当て攻撃から保護する対策がある。たとえば、そのアクションの一部となることを意図していないフィールド値を挿入または更新することはできない。 | ✓ | ✓ | ✓ | 915 |
| **10.4.5** | [追加] アプリケーションはユーザがアクセスするためのパーミッションを持つデータのみを返している。たとえば、API レスポンスは、データオブジェクト自体にアクセスするためのパーミッションを持っていたとしても、ユーザがアクセスするためのパーミッションを持たない値を含む属性での完全なオブジェクトを返さない。 | ✓ | ✓ | ✓ | |
| **10.4.6** | [追加] アプリケーションはレート制限やログ記録などの機密性の高い機能を提供するために、ユーザの実際の IP アドレスを識別して利用できる。 | | ✓ | ✓ | 348 |

## 10.5 セキュリティアーキテクチャ

| # | 説明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **10.5.1** | [修正, 1.14.5 から移動, レベル L2 > L3] アプリケーションアーキテクチャは、サンドボックス化、コンテナ化、ネットワークレベルの分離などの技法を使用して、特にアプリケーションがデシリアライゼーションなどの機密性が高いあるいは危険なアクションを実行しているときに、攻撃者がアプリケーションの他の部分を攻撃するのを遅らせたり阻止している。 | | | ✓ | 265 |

## 参考情報

詳しくは以下の情報を参照してください。

* [Reference on Protecting against DOM Clobbering](https://domclob.xyz/domc_wiki/indicators/patterns.html#secure-patterns--guidelines)
* [OWASP Prototype Pollution Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Prototype_Pollution_Prevention_Cheat_Sheet.html)
* [OWASP Mass Assignment Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Mass_Assignment_Cheat_Sheet.html)
