# V3 セッション管理

## 管理目標

Web ベースのアプリケーションやステートフル API の中核となるコンポーネントのひとつは、それと対話するユーザやデバイスの状態を制御および保守するメカニズムです。セッション管理はステートレスプロトコルをステートフルに変更します。これはさまざまなユーザやデバイスを区別するために重要です。

検証対象のアプリケーションが以下の上位のセッション管理要件を満たすことを確認します。

* セッションは、各個人に固有のものであり、推測や共有することはできません
* セッションは、不要になったときや非アクティブ期間内にタイムアウトしたときに無効になります

前述のように、これらの要件は、一般的な脅威や一般的に悪用される認証の脆弱性にフォーカスした、選択された NIST SP 800-63B 管理策の準拠サブセットとなるように適合されています。以前の検証要件は廃止、重複削除、またはほとんどの場合、必須の [NIST SP 800-63B](https://pages.nist.gov/800-63-3/sp800-63b.html) 要件の意図と厳密に一致するように調整されています。

## V1.3 セッション管理ドキュメント

セッション管理メカニズムは、アプリケーションがステートレスな通信プロトコルを使用している場合でも、時間の経過とともにユーザとデバイスのインタラクションを関連付けることができます。現代のアプリケーションでは、異なる特性と目的を持つ複数のセッション識別子やトークンを利用することがあります。安全なセッション管理システムとは、攻撃者が被害者のセッションを取得、利用、あるいは悪用することを適切に防止するものです。

すべてのアプリケーションに適した単一のパターンはありません。したがって、すべてのケースに適した普遍的な境界と制限を定義することは不可能です。実装とテストの前提条件として、セッション処理に関連するセキュリティ上の決定を文書化したリスク分析を実施しなければなりません。これにより、セッション管理システムがアプリケーションの特定の要件に調整されます。ステートフルと「ステートレス」のどちらのセッションメカニズムを選択するかに関わらず、選択されたソリューションが関連するすべてのセキュリティ要件を満たすことができることを示すために、分析を完了して文書化しなければなりません。

| # | 説明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **1.3.1** | [追加] ユーザのセッション非アクティブ期間と再認証前の最大セッション有効期間が文書化され、他のコントロールと組み合わせて適切であり、そのドキュメントには NIST SP 800-63B 再認証要件からの逸脱の正当性が含まれている。 | ✓ | ✓ | ✓ | |
| **1.3.2** | [追加] ドキュメントには、一つのアカウントで許可される同時 (並列) セッションの数と、アクティブセッションの最大数に達した場合に実行される意図した動作やアクションを定義している。 | ✓ | ✓ | ✓ | |
| **1.3.3** | [追加] フェデレーション ID (federated identity) 管理エコシステムの一部としてユーザセッションを作成および管理するすべてのシステム (SSO システムなど) は、セッションの有効期間、終了、および再認証を必要とするその他の状態を調整するためのコントロールとともに文書化している。 | ✓ | ✓ | ✓ | |

## V3.1 基本セッション管理セキュリティ

このセクションの要件の一部は [NIST のガイダンス](https://pages.nist.gov/800-63-3/sp800-63b.html) のセクション [7.1](https://pages.nist.gov/800-63-3/sp800-63b.html#71-session-bindings) に関連しています。

| # | 説明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **3.1.1** | [削除, 8.3.1 へマージ] | | | | |
| **3.1.2** | [追加] アプリケーションが信頼できるバックエンドサービスを使用してすべてのセッショントークン検証を実行している。 | ✓ | ✓ | ✓ | 603 |
| **3.1.3** | [修正, 3.5.2 から移動, レベル L2 > L1] アプリケーションがセッション管理に暗号保護されたトークンまたはランダムセッショントークンを使用している。静的な API シークレットと API キーは避けるべきである。 | ✓ | ✓ | ✓ | 798 |
| **3.1.4** | [修正, 3.2.2 から移動, 3.2.4 からマージ] ランダムトークンがユーザセッションを表すために使用される場合、そのトークンは一意であり、暗号的に安全な擬似乱数生成器 (CSPRNG) を使用して生成され、少なくとも 128 ビットのエントロピーを持つ。 | ✓ | ✓ | ✓ | |

## V3.2 セッションバインディング

このセクションの要件の一部は [NIST のガイダンス](https://pages.nist.gov/800-63-3/sp800-63b.html) のセクション [7.1](https://pages.nist.gov/800-63-3/sp800-63b.html#71-session-bindings) に関連しています。

| # | 説明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **3.2.1** | [修正] アプリケーションがユーザ認証 (再認証を含む) 時に新しいセッショントークンを生成し、現在のセッショントークンを終了する。 | ✓ | ✓ | ✓ | 384 |
| **3.2.2** | [3.1.4 へ移動] | | | | |
| **3.2.3** | [削除, 8.2.2 へマージ] | | | | |
| **3.2.4** | [削除, 3.1.4 へマージ] | | | | |

TLS や他のセキュアなトランスポートチャネルはセッション管理の必須要件です。これは通信セキュリティの章でカバーされています。

## V3.3 セッションタイムアウト

このセクションの要件の一部は [NIST のガイダンス](https://pages.nist.gov/800-63-3/sp800-63b.html) のセクション [7.2](https://pages.nist.gov/800-63-3/sp800-63b.html#72-reauthentication) に関連しています。

| # | 説明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **3.3.1** | [3.8.1 へ移動] | | | | |
| **3.3.2** | [修正, 3.3.5 へ分割] リスク分析と文書化されたセキュリティ上の決定に従って再認証が強制されるような、絶対的な最大セッション存続期間がある。 | ✓ | ✓ | ✓ | |
| **3.3.3** | [3.8.2 へ移動] | | | | |
| **3.3.4** | [3.7.2 へ移動] | | | | |
| **3.3.5** | [追加, 3.3.2 から分割] 文書化されたセキュリティ上の決定に従って再認証が強制されるような、非アクティブタイムアウトがある。 | ✓ | ✓ | ✓ | 613 |

## V3.4 クッキーベースのセッション管理

| # | 説明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **3.4.1** | [50.2.1 へ移動] | | | | |
| **3.4.2** | [50.2.2 へ移動] | | | | |
| **3.4.3** | [50.2.3 へ移動] | | | | |
| **3.4.4** | [50.2.4 へ移動] | | | | |
| **3.4.5** | [削除, 50.1.1 により廃止] | | | | |

## V3.5 トークンベースのセッション管理

トークンベースのセッション管理には JWT, OAuth, SAML, API キーが含まれます。これらのうち、API キーは脆弱なことが分かっているため、新しいコードでは使用すべきではありません。 JWT と SAML トークンはステートレスセッショントークンの一例です。以下に記載されているすべてのチェックは上述のように信頼できるバックエンドサービスによって実施されるべきです。

| # | 説明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **3.5.1** | [51.2.14 へ移動] | | | | |
| **3.5.2** | [3.1.3 へ移動] | | | | |
| **3.5.3** | [修正, レベル L2 > L1] 暗号的に保護されたトークンがデジタル署名または MAC を使用して検証され、トークンのコンテンツを受け入れる前に改竄を防いでいる。 | ✓ | ✓ | ✓ | 345 |
| **3.5.4** | [追加] トークンデータに有効期間がある場合、トークンとそのコンテンツは検証時間がこの有効期間内である場合にのみ受け入れられる。たとえば、JWT ではクレーム 'nbf' と 'exp' を検証しなければならない。 | ✓ | ✓ | ✓ | 613 |
| **3.5.5** | [追加] 特定のコンテキストでは、許可リストにあるアルゴリズムのみを使用して、暗号的に保護されたトークンを作成および検証している。許可リストには、許可されたアルゴリズム、理想的には対称アルゴリズムあるいは非対称アルゴリズムのいずれかのみ、を含めるべきであり、'None' アルゴリズムを含めるべきではない。対称と非対称の両方が必要な場合は、追加のコントロールで鍵の混乱を防ぐべきである。 | ✓ | ✓ | ✓ | 757 |
| **3.5.6** | [追加] トークンを受け取るサービスは、トークンの内容を受け入れる前に、トークンが正しいタイプであり、意図した目的に適していることを検証している。たとえば、認可の決定にはアクセストークンのみを受け入れることができ、ユーザ認証の証明には ID トークンのみを使用できる。 | ✓ | ✓ | ✓ | |
| **3.5.7** | [追加] 暗号保護されたトークンを検証するために使用される鍵マテリアルは、トークン発行者の事前設定済みの信頼できるソースからのものであり、攻撃者が信頼できないソースや鍵を指定することを防いでいる。JWT やその他の JWS 構造では、'jku', 'x5u', 'jwk' などのヘッダは信頼できるソースの許可リストに照らして検証しなけれならない。 | ✓ | ✓ | ✓ | |
| **3.5.8** | [追加] サービスはそのサービス (オーディエンス) で使用することを意図したトークンのみを受け入れている。JWT では、これはサービス内で定義された許可リストに対して 'aud' クレーム を検証することで達成できる。 | ✓ | ✓ | ✓ | |

## V3.6 フェデレーション再認証

このセクションは依拠当事者（Relying Parties, RP）またはクレデンシャルサービスプロバイダ（Credential Service Provider, CSP）のコードを書いている人に関係するものです。これらの機能を実装するコードに依存する場合には、これらの問題が正しく処理されていることを確認します。

このセクションの要件の一部は [NIST のガイダンス](https://pages.nist.gov/800-63-3/sp800-63b.html) のセクション [7.2.1](https://pages.nist.gov/800-63-3/sp800-63b.html#721-reauthentication-from-a-federation-or-assertion) に関連しています。

| # | 説明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **3.6.1** | [修正, 3.6.2 からマージ] 依拠当事者（Relying Parties, RP）とクレデンシャルサービスプロバイダ (Credential Service Provider, CSP) 間のセッションの有効期間と終了は文書化されたとおりに動作し、CSP 認証イベント間の最大時間に達した場合など、必要に応じて再認証を要求している。 | | | ✓ | 613 |
| **3.6.2** | [削除, 3.6.1 へマージ] | | | | |
| **3.6.3** | [追加] セッションの作成にはユーザの同意または明示的なアクションが必要であり、ユーザとのやり取りなしに新しいアプリケーションセッションが作成されることを防いでいる。 | | ✓ | ✓ | |

## V3.7 セッションの悪用に対する防御

このセクションはクロスサイト攻撃などのベクトルを通じてハイジャックまたは悪用されるアクティブセッションによってもたらされるリスクを軽減するための要件を提供します。

| # | 説明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **3.7.1** | [修正] アプリケーションは、機密性の高いトランザクションや、認証設定などの機密性の高いアカウント属性の変更を許可する前に、再認証や二次検証を要求している。 | ✓ | ✓ | ✓ | 306 |
| **3.7.2** | [修正, 3.3.4 から移動] ユーザは、現在のアクティブセッションの一部またはすべてを表示し、(ログインクレデンシャルを再入力することで) 終了することができる。 | | ✓ | ✓ | |

## V3.8 セッションの終了

セッションの終了はアプリケーション自体によって処理されるか、SSO プロバイダ がアプリケーションの代わりにセッション管理を処理している場合は SSO プロバイダによって処理されます。いくつかの要件はプロバイダによってコントロールされる可能性があるため、このセクションの要件を検討する際に、SSO プロバイダが適用範囲に含まれるかどうかを判断する必要があるかもしれません。

セッションの終了は再認証を必要とし、アプリケーション、フェデレーションログイン（存在する場合）、依拠当事者 (Relying Parties) すべてに有効となっている必要があります。

ステートフルセッションメカニズムの場合、これはバックエンドでセッションを無効にするだけで済みます。署名付きトークンでのステートレスセッションメカニズムを使用している場合、これらのトークンを取り消す方法が必要になります。

このセクションの要件の一部は [NIST のガイダンス](https://pages.nist.gov/800-63-3/sp800-63b.html) のセクション [7.1](https://pages.nist.gov/800-63-3/sp800-63b.html#71-session-bindings) に関連しています。

| # | 説明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **3.8.1** | [修正, 3.3.1 から移動] 「戻る」ボタンや下流の依拠当事者 (Relying Parties) が、認証済みセッションを再開できないように、ログアウトおよび有効期限によってユーザーのセッションが終了する。 | ✓ | ✓ | ✓ | 613 |
| **3.8.2** | [修正, レベル L2 > L1, 3.3.3 から移動] 認証要素が正常に変更または削除 (リセットやリカバリーによるパスワード変更や、存在する場合、MFA 設定の更新を含む) された後、アプリケーションが他のすべてのアクティブセッションを終了するためのオプションを提供している。 | ✓ | ✓ | ✓ | 613 |
| **3.8.3** | [追加] 認証を必要とするすべてのページでログアウト機能に簡単かつ目に見える形でアクセスできる。 | | ✓ | ✓ | |
| **3.8.4** | [追加] ユーザアカウントが無効または削除された場合 (従業員の退職など) 、アプリケーションはすべてのアクティブなセッションを終了する。 | ✓ | ✓ | ✓ | 613 |
| **3.8.5** | [追加] アプリケーション管理者は個々のユーザーまたはすべてのユーザーのアクティブなセッションを終了できる。 | ✓ | ✓ | ✓ | 613 |

## 参考情報

詳しくは以下の情報を参照してください。

* [OWASP Testing Guide 4.0: Session Management Testing](https://owasp.org/www-project-web-security-testing-guide/v41/4-Web_Application_Security_Testing/06-Session_Management_Testing/README.html)
* [OWASP Session Management Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Session_Management_Cheat_Sheet.html)
