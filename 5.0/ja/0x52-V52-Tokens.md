# V52 自己完結型トークン

## 管理目標

自己完結型トークンという概念は 2012 年のオリジナルの RFC 6749 OAuth 2.0 で言及されています。これは事実上、受信側サービスがセキュリティ上の決定を行うために依拠するデータやクレームを含むトークンを指します。これは、受信側サービスがローカルでデータを検索するために使用する単なる識別子であるトークンとは区別されます。自己完結型トークンの最も一般的な例は JSON Web Token (JWT) ですが、SAML アサーションもこのカテゴリに入る可能性があります。

自己完結型トークンの使用は、OIDC/OAuth 以外でも非常に広まっています。同時に、このメカニズムのセキュリティは、トークンの完全性を検証し、トークンが特定のコンテキストに対して有効であることを確保する機能に依存しています。このプロセスには多くの落とし穴があり、この章ではアプリケーションがそれらを防ぐために備えておくべきメカニズムの詳細を具体的に説明します。

## V52.1 トークンのソースと完全性

自己完結型トークンのコンテンツを検査する前に、そのトークンが信頼できるパーティによって生成され、改竄されていないことを確認する必要があります。

| # | 説明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **52.1.1** | [3.5.3 から移動, 修正, レベル L2 > L1] 暗号的に保護されたトークンの真正性がデジタル署名または MAC を使用して検証され、トークンのコンテンツを受け入れる前に改竄を防いでいる。 | ✓ | ✓ | ✓ | 345 |
| **52.1.2** | [追加] 許可リストにあるアルゴリズムのみを使用して、暗号的に保護されたトークンを作成および検証している。許可リストには、現在の勧告に従ってこの目的に強力であるとみなされるアルゴリズム (JWT の PS256 など) のみを含めなければならず、完全性検証が無視されること (JWT の 'None' アルゴリズムを受け入れるなど) を許可してはならない。 | ✓ | ✓ | ✓ | 757 |
| **52.1.3** | [追加] アプリケーションが暗号的に保護されたトークンの真正性を検証する際、指定された暗号アルゴリズムと意図した使用法に対してのみ鍵マテリアルを使用し、鍵攪乱攻撃を防いでいる。JWK 形式で提供される鍵の場合、これは 'kty', 'use', 'key_ops', 'alg' ヘッダを検証することで実行できる。 | ✓ | ✓ | ✓ | |
| **52.1.4** | [追加] アプリケーションは、トークン発行者にバインドされている鍵マテリアルに基づいて、暗号的に保護されたトークンの真正性を検証している。JWT やその他の JWS 構造では、アプリケーションが 'jwk', 'jku', 'x5u', 'kid' ヘッダに基づいて鍵マテリアルを解決する場合、トークン発行者に応じてこれらの値を (たとえば許可リストを使用して) 解釈して検証しなければならない。 | ✓ | ✓ | ✓ | |

## V52.2 トークンコンテンツの使用

自己完結型トークンのコンテンツに基づいてセキュリティ上の決定を行う前に、そのトークンが有効期間内に提示されたこと、および提示された目的のために受信側サービスによって使用されることを検証する必要があります。これは、異なるサービス間や同じ発行者からの異なるトークンタイプでの安全でない相互使用を避けるためです。

OAuth と OIDC の具体的な要件については専用の章で説明します。

| # | 説明 | L1 | L2 | L3 | CWE |
| :---: | :--- | :---: | :---: | :---: | :---: |
| **52.2.1** | [追加] トークンデータに有効期間がある場合、トークンとそのコンテンツは検証時間がこの有効期間内である場合にのみ受け入れられる。たとえば、JWT ではクレーム 'nbf' と 'exp' を検証しなければならない。 | ✓ | ✓ | ✓ | 613 |
| **52.2.2** | [追加] トークンを受け取るサービスは、トークンの内容を受け入れる前に、トークンが正しいタイプであり、意図した目的に適していることを検証している。たとえば、認可の決定にはアクセストークンのみを受け入れることができ、ユーザ認証の証明には ID トークンのみを使用できる。 | ✓ | ✓ | ✓ | |
| **52.2.3** | [追加] サービスはそのサービス (オーディエンス) で使用することを意図したトークンのみを受け入れている。JWT では、これはサービス内で定義された許可リストに対して 'aud' クレーム を検証することで達成できる。 | ✓ | ✓ | ✓ | |

## 参考情報

詳しくは以下の情報を参照してください。

* [OWASP Cheatsheet - JSON Web Token Cheat Sheet for Java](https://cheatsheetseries.owasp.org/cheatsheets/JSON_Web_Token_for_Java_Cheat_Sheet.html) (なお役に立つ一般的なガイダンスがあります)
